<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light">
    <title>Lizzy - AI Screenplay Writing</title>
    <link rel="stylesheet" href="styles/common.css">
    <style>
        /* Landing page spacing overrides - fit in viewport */
        body {
            overflow: auto;
        }

        .container-wide {
            min-height: 100vh;
            max-width: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        /* Red header bar */
        .header-bar {
            background: var(--color-primary);
            padding: var(--spacing-md) var(--spacing-xl);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .header-left h1 {
            font-size: 3em;
            color: var(--color-white);
            margin: 0;
            line-height: 1;
        }

        .header-left .tagline {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.85);
            font-style: italic;
            margin-top: 4px;
        }

        .header-right {
            display: flex;
            gap: var(--spacing-xs);
            align-items: center;
            justify-content: flex-end;
        }

        #project-dropdown {
            padding: 12px var(--spacing-md);
            font-size: 0.9em;
            width: 400px;
            height: 48px;
        }

        .btn-new-project {
            padding: 12px 16px;
            font-size: 1.2em;
            min-width: auto;
            width: 48px;
            height: 48px;
            background: var(--color-white);
            color: var(--color-primary);
            border: 2px solid var(--color-white);
            border-radius: 24px;
            cursor: pointer;
            transition: all var(--transition-normal);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-new-project:hover {
            background: var(--color-primary-light);
            transform: scale(1.05);
        }

        .btn-delete-project {
            padding: 12px 16px;
            font-size: 1.2em;
            min-width: auto;
            width: 48px;
            height: 48px;
            background: var(--color-white);
            color: #dc3545;
            border: 2px solid var(--color-white);
            border-radius: 24px;
            cursor: pointer;
            transition: all var(--transition-normal);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-delete-project:hover {
            background: #dc3545;
            color: white;
            transform: scale(1.05);
        }

        /* Empty state message */
        .empty-state-message {
            display: none;
        }

        /* Prominent button in empty state */
        .btn-prominent {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(184, 62, 62, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(184, 62, 62, 0.3);
            }
            50% {
                box-shadow: 0 6px 20px rgba(184, 62, 62, 0.5);
            }
        }

        /* Main content area */
        .main-content-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex: 1;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            padding: var(--spacing-xl) var(--spacing-lg);
        }

        /* Pipeline list */
        .pipeline {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        /* Step cards */
        .step {
            background: var(--color-white);
            border: 3px solid var(--color-primary);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 12px rgba(184, 62, 62, 0.15);
            display: grid;
            grid-template-columns: 60px 1fr auto;
            gap: var(--spacing-md);
            align-items: center;
            padding: var(--spacing-lg);
            min-height: 120px;
            transition: all var(--transition-fast);
            cursor: pointer;
            position: relative;
        }

        .step:hover {
            box-shadow: 0 6px 20px rgba(184, 62, 62, 0.25);
            transform: translateY(-2px);
        }

        .step-number {
            width: 52px;
            height: 52px;
            background: var(--color-primary);
            color: var(--color-white);
            font-size: 1.6em;
            font-weight: 700;
            font-family: var(--font-serif);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(184, 62, 62, 0.3);
            line-height: 1;
            flex-shrink: 0;
            text-align: center;
        }

        .step-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .step-title {
            font-size: 1.4em;
            color: var(--color-primary);
            font-weight: 700;
            font-family: var(--font-serif);
            line-height: 1.1;
        }

        .step-description {
            font-size: 0.85em;
            color: var(--color-text-light);
            line-height: 1.3;
        }

        .step-action {
            padding: 10px 24px;
            background: var(--color-primary);
            color: var(--color-white);
            border: none;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            border-radius: 24px;
            font-family: var(--font-serif);
            box-shadow: 0 2px 6px rgba(184, 62, 62, 0.3);
            white-space: nowrap;
        }

        .step-action:hover {
            background: var(--color-primary-dark);
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(184, 62, 62, 0.4);
        }

        .step.completed {
            opacity: 0.8;
        }

        .step.completed .step-number {
            background: #28a745;
        }

        .step.completed .step-number::after {
            content: '✓';
            position: absolute;
            font-size: 0.9em;
        }

        /* Shake animation for dropdown */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container-wide {
                padding: var(--spacing-sm);
            }

            .header-bar {
                flex-direction: column;
                gap: var(--spacing-xs);
                align-items: flex-start;
            }

            .header-left h1 {
                font-size: 1.6em;
            }

            .header-right {
                width: 100%;
            }

            #project-dropdown {
                flex: 1;
            }

            .step {
                grid-template-columns: 40px 1fr;
                gap: var(--spacing-xs);
                padding: var(--spacing-sm);
            }

            .step-number {
                width: 40px;
                height: 40px;
                font-size: 1.4em;
            }

            .step-action {
                grid-column: 2;
                justify-self: start;
                margin-top: var(--spacing-xs);
                padding: 8px 20px;
                font-size: 0.85em;
            }

            .step-title {
                font-size: 1.2em;
            }

            .step-description {
                font-size: 0.8em;
            }
        }

        /* Getting Started Help Button */
        .help-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(184, 62, 62, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(184, 62, 62, 0.6);
        }

        /* Help Modal */
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .help-modal.active {
            display: flex;
        }

        .help-modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 3px solid var(--color-primary);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .help-modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .help-modal-header h2 {
            color: var(--color-primary);
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .help-modal-body {
            color: var(--color-text);
            font-size: 1.1em;
            line-height: 1.8;
        }

        .help-modal-body p {
            margin-bottom: 20px;
        }

        .help-modal-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0e8e8;
            font-style: italic;
            color: var(--color-text-light);
        }

        .help-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            font-size: 2em;
            color: var(--color-text-light);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .help-modal-close:hover {
            background: #f0e8e8;
            color: var(--color-primary);
        }
    </style>
</head>
<body>
    <div class="container-wide">
        <!-- Header Bar -->
        <div class="header-bar">
            <div class="header-left">
                <h1>Lizzy</h1>
                <div class="tagline">Three acts, three steps.</div>
            </div>
            <div class="header-right">
                <select id="project-dropdown" class="form-select" onchange="selectProject()">
                    <option value="">Select a project...</option>
                </select>
                <button class="btn-new-project" onclick="createNewProject()" title="Create New Project">+</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
            <!-- Pipeline Steps -->
            <div class="pipeline">
            <div class="step" id="step-1" onclick="navigateTo('manager');">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="step-title">Setup</div>
                    <div class="step-description">Configure project, characters, scenes</div>
                </div>
                <button class="step-action" onclick="navigateTo('manager'); event.stopPropagation();">Go →</button>
            </div>

            <div class="step" id="step-2" onclick="navigateTo('brainstorm');">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="step-title">Brainstorm</div>
                    <div class="step-description">Generate ideas with AI knowledge graphs</div>
                </div>
                <button class="step-action" onclick="navigateTo('brainstorm'); event.stopPropagation();">Go →</button>
            </div>

            <div class="step" id="step-3" onclick="navigateTo('write');">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="step-title">Write</div>
                    <div class="step-description">Convert brainstorms to screenplay format</div>
                </div>
                <button class="step-action" onclick="navigateTo('write'); event.stopPropagation();">Go →</button>
            </div>
        </div>
        </div>
    </div>

    <!-- Message Container -->
    <div id="message-container"></div>

    <script src="js/common.js"></script>
    <script>
        // Track project status
        let projectStatus = {
            currentProject: null,
            steps: {
                start: false,
                intake: false,
                brainstorm: false,
                write: false,
                export: false
            }
        };

        // Load projects into dropdown
        async function loadProjects() {
            try {
                console.log('Loading projects...');
                const response = await fetch('/api/projects');
                const data = await response.json();
                console.log('Projects data:', data);

                const dropdown = document.getElementById('project-dropdown');
                console.log('Dropdown element:', dropdown);
                const currentProject = localStorage.getItem('currentProject');

                // Clear existing options except first
                dropdown.innerHTML = '<option value="">Select a project...</option>';

                // Add projects
                data.projects.forEach(project => {
                    console.log('Adding project:', project.name);
                    const option = document.createElement('option');
                    option.value = project.name;  // folder name for API calls
                    option.textContent = project.display_name || project.name;  // human-readable name for display
                    if (project.name === currentProject) {
                        option.selected = true;
                    }
                    dropdown.appendChild(option);
                });

                // If a project was already selected, make sure it's still active
                if (currentProject && dropdown.value === currentProject) {
                    projectStatus.currentProject = currentProject;
                    console.log('Restored project selection:', currentProject);

                    // Enable step cards
                    document.getElementById('step-2').style.opacity = '1';
                    document.getElementById('step-3').style.opacity = '1';
                    document.getElementById('step-2').style.pointerEvents = 'auto';
                    document.getElementById('step-3').style.pointerEvents = 'auto';
                }

                console.log('Total options in dropdown:', dropdown.options.length);
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        // Select a project
        function selectProject() {
            const dropdown = document.getElementById('project-dropdown');
            const projectName = dropdown.value;

            if (projectName) {
                localStorage.setItem('currentProject', projectName);
                projectStatus.currentProject = projectName;
                console.log('Selected project:', projectName);

                // Enable step cards
                document.getElementById('step-2').style.opacity = '1';
                document.getElementById('step-3').style.opacity = '1';
                document.getElementById('step-2').style.pointerEvents = 'auto';
                document.getElementById('step-3').style.pointerEvents = 'auto';
            } else {
                localStorage.removeItem('currentProject');
                projectStatus.currentProject = null;

                // Disable step cards
                document.getElementById('step-2').style.opacity = '0.5';
                document.getElementById('step-3').style.opacity = '0.5';
                document.getElementById('step-2').style.pointerEvents = 'none';
                document.getElementById('step-3').style.pointerEvents = 'none';
            }
        }

        // Create new project
        function createNewProject() {
            // Clear current project so Manager shows new project form
            localStorage.removeItem('currentProject');
            window.location.href = '/manager';
        }

        // Delete project
        async function deleteProject() {
            const dropdown = document.getElementById('project-dropdown');
            const projectName = dropdown.value;

            if (!projectName) {
                showMessage('⚠️ No project selected', 'warning');
                return;
            }

            // Get display name for confirmation
            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const displayName = selectedOption.textContent;

            // Confirmation dialog
            const confirmed = confirm(
                `⚠️ DELETE PROJECT?\n\n` +
                `Project: ${displayName}\n\n` +
                `This will permanently delete:\n` +
                `• All scenes and content\n` +
                `• All brainstorms and drafts\n` +
                `• All project data\n\n` +
                `This action CANNOT be undone!\n\n` +
                `Are you sure you want to delete this project?`
            );

            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${projectName}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(`✓ Project "${displayName}" deleted successfully`, 'success');

                    // Clear current project from localStorage
                    localStorage.removeItem('currentProject');
                    projectStatus.currentProject = null;

                    // Hide delete button
                    document.getElementById('btn-delete-project').style.display = 'none';

                    // Disable step cards
                    document.getElementById('step-2').style.opacity = '0.5';
                    document.getElementById('step-3').style.opacity = '0.5';
                    document.getElementById('step-2').style.pointerEvents = 'none';
                    document.getElementById('step-3').style.pointerEvents = 'none';

                    // Reload projects list
                    await loadProjects();
                } else {
                    showMessage(`✗ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                showMessage('✗ Failed to delete project', 'error');
            }
        }

        // Load status from localStorage
        function loadStatus() {
            const saved = localStorage.getItem('lizzy_status');
            if (saved) {
                projectStatus = JSON.parse(saved);
                updateUI();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProjects();
            loadStatus();

            // Enable/disable step cards based on project selection
            const currentProject = localStorage.getItem('currentProject');
            if (!currentProject) {
                // Disable Brainstorm and Write cards if no project selected
                document.getElementById('step-2').style.opacity = '0.5';
                document.getElementById('step-3').style.opacity = '0.5';
                document.getElementById('step-2').style.pointerEvents = 'none';
                document.getElementById('step-3').style.pointerEvents = 'none';
            }
        });

        // Save status to localStorage
        function saveStatus() {
            localStorage.setItem('lizzy_status', JSON.stringify(projectStatus));
        }

        // Update UI based on completion status
        function updateUI() {
            Object.keys(projectStatus.steps).forEach((step, index) => {
                const stepElement = document.getElementById(`step-${index + 1}`);
                if (projectStatus.steps[step]) {
                    stepElement.classList.add('completed');
                }
            });
        }

        // Navigation
        function navigateTo(module) {
            console.log(`Navigating to: ${module}`);

            if (module === 'manager') {
                window.location.href = '/manager';
            } else if (module === 'brainstorm' || module === 'write') {
                const currentProject = localStorage.getItem('currentProject');
                if (!currentProject) {
                    // Highlight the dropdown to show user what to do
                    const dropdown = document.getElementById('project-dropdown');
                    dropdown.style.animation = 'shake 0.5s';
                    dropdown.focus();
                    setTimeout(() => dropdown.style.animation = '', 500);
                    showMessage('⚠️ Please select a project from the dropdown first!', 'warning', 3000);
                    return;
                }
                navigateWithProject('/' + module);
            } else if (module === 'export') {
                localStorage.setItem('defaultTab', 'screenplay');
                navigateWithProject('/manager');
            } else {
                showMessage(`Module "${module}" not yet implemented in web interface`, 'warning');
            }
        }

        function showPromptStudio() {
            alert('Run this command in your terminal:\n\n./start_prompt_studio.sh\n\nThen open: http://localhost:8001');
        }

        function showProjects() {
            alert('Project browser coming soon!\n\nFor now, check: projects/ directory');
        }

        // Getting Started Help Modal
        function openHelpModal() {
            document.getElementById('help-modal').classList.add('active');
        }

        function closeHelpModal() {
            document.getElementById('help-modal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('help-modal');
            if (event.target === modal) {
                closeHelpModal();
            }
        });
    </script>

    <!-- Getting Started Help Button -->
    <button class="help-button" onclick="openHelpModal()" title="Getting Started">?</button>

    <!-- Help Modal -->
    <div id="help-modal" class="help-modal">
        <div class="help-modal-content">
            <button class="help-modal-close" onclick="closeHelpModal()">×</button>
            <div class="help-modal-header">
                <h2>Getting Started</h2>
            </div>
            <div class="help-modal-body">
                <p>Welcome to <strong>Lizzy</strong>: the first AI-powered tool designed to help you bring your dream romcom to life in three simple steps.</p>

                <p>Start by clicking the <strong>"+"</strong> button to create your project, then head over to <strong>Setup</strong>. Here, you can enter details about your story: characters, scene outlines, and notes. Or, if you'd rather let the AI take the lead, scroll to the bottom and click <strong>Generate</strong> to have Lizzy craft a brand-new love story for you.</p>

                <p>Once your story framework is ready, move to <strong>Brainstorm</strong>, where Lizzy's expert knowledge bases collaborate to develop your ideas. You'll receive creative insights from ChatGPT 5, enriched by knowledge graphs built from the best screenwriting books, Shakespeare's timeless plays, and a curated set of 90 favorite romcoms.</p>

                <p>After brainstorming, it's time to <strong>write your romcom!</strong> You can generate a full draft or scene-by-scene writing sessions — whichever suits your process best.</p>
            </div>
            <div class="help-modal-footer">
                <p>If you have any questions, feel free to reach out at <strong>ellejansickresearch@gmail.com</strong>, I'd love to hear from you.</p>
                <p style="margin-top: 10px;">Thanks,<br><strong>Elle</strong></p>
            </div>
        </div>
    </div>
</body>
</html>
